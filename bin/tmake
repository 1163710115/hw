#!/usr/bin/env perl

##
## build tree
##
use Getopt::Long;
use Data::Dumper;
use YAML qw(LoadFile);

my $MAKE = "make";

#=============================
## Options
#=============================
my @build;
GetOptions (
             "help|h" => sub {usage(); exit 0},
             "build|b=s" => \@build,
           ) or die "Unrecognized options @ARGV";

#=============================
## Global Variables
#=============================
my $tree = LoadFile("etc/build.config");
my %done;

while (%$tree) {
    my ($key,$value) = each %$tree;
    
    #print Dumper($tree);
    my $leaf = find_any_leaf($key);

    #print "key=$key\n"; 
    #print "leaf=$leaf\n"; 

    foreach my $sandbox (@{$tree->{$leaf}{sandbox}}) {
        system("$MAKE -C $sandbox")==0 or die "$sandbox build fail: $?";
    }
    
    $done{$leaf} = 1;
    delete $tree->{$leaf};
}

sub find_any_leaf {
    my $key = shift;

    my $leaf;
    if (exists $tree->{$key}{dependencies}) {
        foreach my $dep (@{$tree->{$key}{dependencies}}) {
            next if exists $done{$dep};
            return find_any_leaf($dep);
        }
    }
    return $key;
}

sub get_projects {
    my $file = shift;

    my @projects;
    open my $fh,"<",$file or die;
    while (my $line = <$fh>) {
        chomp $line;
        next unless $line =~ /^\s*PROJECTS/;
        my $str = $1 if $line =~ /=(.*)/;
        @projects = split(' ',$str);
    }
    close $fh;

    #print Dumper(\@projects);
    return @projects;
}

sub usage()
{
    print
    	"Usage: tmake\n",
}
